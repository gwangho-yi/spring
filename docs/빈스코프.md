## ë¹ˆ ìŠ¤ì½”í”„ë€?

ìŠ¤í”„ë§ ë¹ˆì€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ ì‹œì‘â†’ ì¢…ë£Œê¹Œì§€ ìœ ì§€ëœë‹¤.

ìŠ¤í”„ë§ ë¹ˆì´ ê¸°ë³¸ì ìœ¼ë¡œ ì‹±ê¸€í†¤ ìŠ¤ì½”í”„ë¡œ ìƒì„±ë˜ê¸° ë•Œë¬¸.

ìŠ¤ì½”í”„ : ë¹ˆì´ ì¡´ì¬í•  ìˆ˜ ìˆëŠ” ë²”ìœ„

### ìŠ¤í”„ë§ì˜ ìŠ¤ì½”í”„ ì¢…ë¥˜

- ì‹±ê¸€í†¤ : ê¸°ë³¸ ìŠ¤ì½”í”„, ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ ì‹œì‘ê³¼ ì¢…ë£Œê¹Œì§€ ìœ ì§€ë˜ëŠ” ê°€ì¥ ë„’ì€ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§
- í”„ë¡œí† íƒ€ì… : ë¹ˆì˜ ìƒì„±ê³¼ ì˜ì¡´ ê´€ê³„ ì£¼ì…ê¹Œì§€ë§Œ ê´€ì—¬í•˜ê³  ë”ëŠ” ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì§§ì€ ë²”ìœ„
- ì›¹ ê´€ë ¨ ìŠ¤ì½”í”„
  - request : ì›¹ ìš”ì²­ì´ ë“¤ì–´ì˜¤ê³  ë‚˜ê°ˆë•Œ ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„
  - session : ì›¹ ì„¸ì…˜ì´ ìƒì„±ë˜ê³  ì¢…ë£Œë  ë•Œ ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„
  - application : ì›¹ì˜ ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ì™€ ê°™ì€ ë²”ìœ„ë¡œ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„

## í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„

ì‹±ê¸€í†¤ ìŠ¤ì½”í”„ ë¹ˆì„ ì¡°íšŒí•˜ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì˜ ìŠ¤í”„ë§ ë¹ˆì„ ë°˜í™˜í•œë‹¤.

í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ëŠ” ì»¨í…Œì´ë„ˆì— ì¡°íšŒí•˜ë©´ ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ì„œ ë°˜í™˜í•œë‹¤.

1. í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ ë¹ˆì„ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìš”ì²­í•œë‹¤.
2. ì»¨í…Œì´ë„ˆëŠ” í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•˜ê³ , í•„ìš”í•œ ì˜ì¡´ê´€ê³„ë¥¼ ì£¼ì…í•œë‹¤.
3. ìƒˆë¡œìš´ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ 2ë¥¼ ë‹¤ì‹œ ë°˜ë³µí•œë‹¤.

ì¦‰, ìš”ì²­ í•˜ë‚˜í•˜ë‚˜ ë§ˆë‹¤ ìƒˆë¡œìš´ ê°ì²´ê°€ ìƒì„±ëœë‹¤.

<aside>
ğŸ’¡ ì •ë¦¬

- í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•˜ê³ , ìœ„ì¡´ê´€ê³„ ì£¼ì…, ì´ˆê¸°í™”ê¹Œì§€ë§Œ ì²˜ë¦¬í•œë‹¤.
- ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” ìƒì„±ëœ ë¹ˆì„ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì»¨í…Œì´ë„ˆì— ì˜í•´ ë” ì´ìƒ ê´€ë¦¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œ @PreDestroy ê°™ì€ ì¢…ë£Œ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤. destroyë¡œ ì¢…ë£Œì‹œì¼œì•¼í•œë‹¤.
</aside>

## í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ - ì‹±ê¸€í†¤ ë¹ˆê³¼ ì‚¬ìš©ì‹œ ë¬¸ì œì 

```java
@Test
void singletonClientUsePrototype() {
    AnnotationConfigApplicationContext ac =
            new AnnotationConfigApplicationContext(ClientBean.class, PrototypeBean.class);

    ClientBean clientBean1 = ac.getBean(ClientBean.class);
    int count1 = clientBean1.logic();
    assertThat(count1).isEqualTo(1);
    ClientBean clientBean2 = ac.getBean(ClientBean.class);
    int count2 = clientBean2.logic();
    assertThat(count2).isEqualTo(2);
}

@RequiredArgsConstructor
static class ClientBean {
    private final PrototypeBean prototypeBean;

    public int logic() {
        prototypeBean.addCount();
        return prototypeBean.getCount();
    }
}

@Getter
@Scope("prototype")
static class PrototypeBean {
    private int count = 0;

    public void addCount() {
        count++;
    }

    @PostConstruct
    public void init() {
        System.out.println("PrototypeBean.init" + this);
    }

    @PreDestroy
    public void destroy() {
        System.out.println("PrototypeBean.destroy");
    }

}
```

ì‹±ê¸€í†¤ ë¹ˆì—ì„œ í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ë¥¼ ê°€ì§„ ë¹ˆì„ ì°¸ì¡° ì¤‘ì¼ ë•Œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ëŠ” ì“¸ë•Œë§ˆë‹¤ ë°”ë¡œë°”ë¡œ ìƒì„±í•˜ê³  ì—†ì• ê³  ì‹¶ì€ë°, ì‹±ê¸€í†¤ ë¹ˆ ì•ˆì— ìˆê¸° ë•Œë¬¸ì— ê³„ì† ìœ ì§€ê°€ ëœë‹¤. ì‹±ê¸€í†¤ ë¹ˆì´ ê³„ì† ì¡ê³  ìˆìœ¼ë‹ˆê¹, ì†Œë©¸ë˜ê¸° ê¹Œì§€ëŠ” ê³„ì† ë¶™ì¡í˜€ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

## í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ - ì‹±ê¸€í†¤ ë¹ˆê³¼ ì‚¬ìš©ì‹œ Providerë¡œ ë¬¸ì œí•´ê²°

ì‹±ê¸€í†¤ ë¹ˆê³¼ í”„ë¡œí† íƒ€ì… ë¹ˆ ê°™ì´ ì‚¬ìš© ì‹œ, ìƒˆë¡œìš´ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•˜ëŠ” ë°©ë²•

### ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìš”ì²­

ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë§¤ë²ˆ ìƒˆë¡œìš´ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìš”ì²­í•œë‹¤.

```java
AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext(PrototypeBean.class);
PrototypeBean prototypeBean1 = ac.getBean(PrototypeBean.class);
```

- `ac.getBean` ìœ¼ë¡œ í•­ìƒ ìƒˆë¡œìš´ í”„ë¡œí† íƒ€ì… ë¹ˆì´ ìƒì„±ëœë‹¤.
- ì˜ì¡´ ê´€ê³„ë¥¼ ì™¸ë¶€ì—ì„œ ì£¼ì… ë°›ëŠ”ê²Œ ì•„ë‹ˆë¼ ì§ì ‘ í•„ìš”í•œ ì˜ì¡´ ê´€ê³„ë¥¼ ì°¾ëŠ” ê²ƒì„ Dependency Lookup (DL) ì˜ì¡´ê´€ê³„ ì¡°íšŒ(íƒìƒ‰)ì´ë¼ê³  í•œë‹¤.
- í•˜ì§€ë§Œ ì•± ì»¨í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ ì£¼ì… ë°›ê²Œ ë˜ë©´, ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì¢…ì†ì ì¸ ì½”ë“œê°€ ë˜ê³ , ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë„ ì–´ë ¤ì›Œì§„ë‹¤

### ObjectFactory, ObjectProvider

- ë¹ˆì„ ì»¨í…Œì´ë„ˆì—ì„œ ëŒ€ì‹  ì°¾ì•„ì£¼ëŠ” DL ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì´ `ObjectProvider`
- `ObjectProvider`ëŠ”`ObjectFactory` ì˜ ê¸°ëŠ¥ì„ ì¶”ê°€í•œ ê²ƒ. getObjectëŠ” ì›ë˜ `ObjectFactory` ì˜ ê¸°ëŠ¥.
- getObject ê°€ DLì„ í•´ì¤€ë‹¤.
- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ë§Œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê±°ë‚˜ mock ì½”ë“œë¥¼ ë§Œë“¤ê¸°ëŠ” í›¨ì”¬ ì‰¬ì›Œì§„ë‹¤.

```java
@RequiredArgsConstructor
static class ClientBean {

    private final ObjectProvider<PrototypeBean> prototypeBeanObjectProvider;

    public int logic() {
        PrototypeBean prototypeBean = prototypeBeanObjectProvider.getObject();
        prototypeBean.addCount();
        return prototypeBean.getCount();
    }
}
```

ë¹ˆì„ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ë•Œ ë°”ë¡œë°”ë¡œ ìƒì„±í•˜ê³  ì—†ì• ì¤„ ë•ŒëŠ” ObjectProviderë¥¼ ì‚¬ìš©í•˜ì!

## ì›¹ ìŠ¤ì½”í”„

### ì›¹ ìŠ¤ì½”í”„ íŠ¹ì§•

- ì›¹ í™˜ê²½ì—ì„œë§Œ ë™ì‘.
- í”„ë¡œí†  íƒ€ì…ê³¼ ë‹¤ë¥´ê²Œ ìŠ¤í”„ë§ì´ í•´ë‹¹ ìŠ¤ì½”í”„ì˜ ì¢…ë£Œ ì‹œì ê¹Œì§€ ê´€ë¦¬í•œë‹¤. ë”°ë¼ì„œ ì¢…ë£Œ ë©”ì„œë“œê°€ í˜¸ì¶œëœ

### ì›¹ ìŠ¤ì½”í”„ ì¢…ë¥˜

- request : HTTP ìš”ì²­ í•˜ë‚˜ê°€ ë“¤ì–´ì˜¤ê³  ë‚˜ê°ˆ ë•Œ ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„, ìš”ì²­ë§ˆë‹¤ ë³„ë„ì˜ ë¹ˆ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±, ê´€ë¦¬ëœë‹¤.
- session : HTTP Sessionê³¼ ë™ì¼í•œ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ëŠ” ìŠ¤ì½”í”„
- application : ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ëŠ” ìŠ¤ì½”í”„
- websocket : ì›¹ ì†Œì¼“ê³¼ ë™ì¼í•œ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ëŠ” ìŠ¤ì½”í”„

![img_16.png](img_16.png)

## requst ìŠ¤ì½”í”„ ì˜ˆì œ ë§Œë“¤ê¸°

```java
//web ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
implementation 'org.springframework.boot:spring-boot-starter-web' 
```

spring-boot-starter-web ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•˜ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë‚´ì¥ í†°ì¼“ ì„œë²„ë¥¼ í™œìš©í•´ì„œ ì›¹ ì„œ
ë²„ì™€ ìŠ¤í”„ë§ì„ í•¨ê»˜ ì‹¤í–‰ì‹œí‚¨ë‹¤.

```java
Tomcat started on port(s): 8080 (http) with context path ''
Started CoreApplication in 0.914 seconds (JVM running for 1.528)
```

> ì›¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ `AnnotationConfigApplicationContext` ì„ ê¸°ë°˜ìœ¼ë¡œ ì•±ì„ êµ¬ë™í•œë‹¤.
ì›¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¶”ê°€ë˜ë©´ ì›¹ ê´€ë ¨ ì„¤ì •ê³¼ í™˜ê²½ë“¤ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— `AnnotationConfigServletWebServerApplicationContext` ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•±ì„ êµ¬ë™í•œë‹¤.
>

### request ìŠ¤ì½”í”„ ì˜ˆì œ

reqest ìŠ¤ì½”í”„ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ HTTP ìš”ì²­ì˜ ë¡œê·¸ë¥¼ êµ¬ë¶„ ì§€ì„ ìˆ˜ ìˆë‹¤.

- ê¸°ëŒ€í•˜ëŠ” ê³µí†µ í¬ë©§: [UUID] [requestURL] {message}
- UUIDë¥¼ ì‚¬ìš©í•´ì„œ HTTP ìš”ì²­ì„ êµ¬ë¶„.
- requestURL ì •ë³´ë„ ì¶”ê°€ë¡œ ë„£ì–´ì„œ ì–´ë–¤ URLì„ ìš”ì²­í•´ì„œ ë‚¨ì€ ë¡œê·¸ì¸ì§€ í™•ì¸.

```java
@Component
@Scope(value = "request")
@Setter
public class MyLogger {
    private String uuid;
    private String requestURL;

    public void log(String message) {
        System.out.println("[" + uuid + "] "
                + "[" + requestURL + "] "
                + message);
    }

    @PostConstruct
    public void init() {
        uuid = UUID.randomUUID().toString();
        System.out.println("[" + uuid + "] request scope bean create: "
                + this);
    }

    @PreDestroy
    public void close() {
        System.out.println("[" + uuid + "] request scope bean close: "
                + this);
    }
}
```

```java
@Controller
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final MyLogger myLogger;

    @RequestMapping("log-demo")
    @ResponseBody
    public String logDemo(HttpServletRequest request) {
        String requestURL = request.getRequestURL().toString();
        myLogger.setRequestURL(requestURL);

        myLogger.log("controller test");
        logDemoService.logic("testId");
        return "OK";
    }
}
```

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {
    private final MyLogger myLogger;
    
    public void logic(String id) {
        myLogger.log("service id = " + id);
    }
}
```

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œë„ ë¡œê·¸ë¥¼ ì¶œë ¥í•´ë³´ì.
- ì—¬ê¸°ì„œ ì¤‘ìš”í•œì ì´ ìˆë‹¤. request scopeë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  íŒŒë¼ë¯¸í„°ë¡œ ì´ ëª¨ë“  ì •ë³´ë¥¼ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë„˜ê¸´ë‹¤ë©´, íŒŒë¼ë¯¸í„°ê°€ ë§ì•„ì„œ ì§€ì €ë¶„í•´ì§„ë‹¤.
- ë” ë¬¸ì œëŠ” requestURL ê°™ì€ ì›¹ê³¼ ê´€ë ¨ëœ ì •ë³´ê°€ ì›¹ê³¼ ê´€ë ¨ì—†ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µê¹Œì§€ ë„˜ì–´ê°€ê²Œ ëœë‹¤.
- ì›¹ê³¼ ê´€ë ¨ëœ ë¶€ë¶„ì€ ì»¨íŠ¸ë¡¤ëŸ¬ê¹Œì§€ë§Œ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ì„œë¹„ìŠ¤ ê³„ì¸µì€ ì›¹ ê¸°ìˆ ì— ì¢…ì†ë˜ì§€ ì•Šê³ , ê°€ê¸‰ì  ìˆœìˆ˜í•˜ê²Œ ìœ ì§€í•˜ëŠ” ê²ƒì´ ìœ ì§€ë³´ìˆ˜ ê´€ì ì—ì„œ ì¢‹ë‹¤.
- request scopeì˜ MyLogger ë•ë¶„ì— ì´ëŸ° ë¶€ë¶„ì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ì§€ ì•Šê³ , MyLoggerì˜ ë©¤ë²„ë³€ìˆ˜ì— ì €ì¥í•´ì„œ ì½”ë“œì™€ ê³„ì¸µì„ ê¹”ë”í•˜ê²Œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤

í•˜ì§€ë§Œ ì´ ì½”ë“œë§Œìœ¼ë¡œëŠ” ì—ëŸ¬ê°€ ë‚œë‹¤. ë¦¬í€˜ìŠ¤íŠ¸ ìŠ¤ì½”í”„ëŠ” ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•Šì•˜ì„ ë• ìƒì„±ì„ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë“±ë¡ì´ ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤.

## ìŠ¤ì½”í”„ì™€ Provider

ë¦¬í€˜ìŠ¤íŠ¸ ìŠ¤ì½”í”„ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ObjectProviderë¥¼ ì‚¬ìš©í•˜ë©´ ìš”ì²­ì´ ë°œìƒí•œ ì‹œì ì— ì˜ì¡´ì„±ì„ ê°–ëŠ” ë¹ˆì„ ê²€ìƒ‰(DL)í•´ì„œ  ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ìš”ì²­ ë•Œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ `MyLogger` ë¥¼ ìƒì„±í•´ì¤€ë‹¤.

```java
@Controller
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final ObjectProvider<MyLogger> myLoggerProvider;

    @RequestMapping("log-demo")
    @ResponseBody
    public String logDemo(HttpServletRequest request) throws InterruptedException {
        MyLogger object = myLoggerProvider.getObject();
        String requestURL = request.getRequestURL().toString();
        object.setRequestURL(requestURL);

        object.log("controller test");
        Thread.sleep(1000);
        logDemoService.logic("testId");
        return "OK";
    }
}
```

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final ObjectProvider<MyLogger> myLoggerProvider;
    public void logic(String id) {
        MyLogger object = myLoggerProvider.getObject();
        object.log("service id = " + id);
    }
}
```


## ìŠ¤ì½”í”„ì™€ í”„ë¡ì‹œ

### ìŠ¤ì½”í”„ í”„ë¡ì‹œ ì‚¬ìš©ë²•

- ObjectProvider ë¥¼ ì‚¬ìš© í•˜ë˜ ì½”ë“œë¥¼ í”„ë¡ì‹œë¡œ ë³€ê²½í•œë‹¤.
- `@Scope(value = "request", proxyMode = ScopedProxyMode.*TARGET_CLASS*)` ì¶”ê°€
- ì ìš© ëŒ€ìƒì´ ì¸í„°í˜ì´ìŠ¤ë¼ë©´ `*TARGET_INTERFACE` ë¡œ ë³€ê²½*
- MyLogger í´ë˜ìŠ¤ì˜ ê°€ì§œ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³ , HTTP ìš”ì²­ì— ìƒê´€ ì—†ì´ ê°€ì§œ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ë‹¤ë¥¸ ë¹ˆì— ë¯¸ë¦¬ ì£¼ì…í•´ ë‘˜ ìˆ˜ ìˆë‹¤.

```java
@Component
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
@Setter
public class MyLogger {
    private String uuid;
    private String requestURL;

    public void log(String message) {
        System.out.println("[" + uuid + "] "
                + "[" + requestURL + "] "
                + message);
    }

    @PostConstruct
    public void init() {
        uuid = UUID.randomUUID().toString();
        System.out.println("[" + uuid + "] request scope bean create: "
                + this);
    }

    @PreDestroy
    public void close() {
        System.out.println("[" + uuid + "] request scope bean close: "
                + this);
    }
}
```

```java
@Controller
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final MyLogger myLogger;

    @RequestMapping("log-demo")
    @ResponseBody
    public String logDemo(HttpServletRequest request) throws InterruptedException {
        String requestURL = request.getRequestURL().toString();
        myLogger.setRequestURL(requestURL);

        myLogger.log("controller test");
        Thread.sleep(1000);
        logDemoService.logic("testId");
        return "OK";
    }
}
```

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final MyLogger myLogger;
    public void logic(String id) {
        myLogger.log("service id = " + id);
    }
}
```

ì´ì œ ì‹¤í–‰í•˜ë©´ request ì›¹ ìŠ¤ì½”í”„ë¼ë„ ì‹¤í–‰ì´ ëœë‹¤.

ë¡œê·¸ë¥¼ í•œë²ˆ ì‚´í´ë³´ì

```java
@RequestMapping("log-demo")
    @ResponseBody
    public String logDemo(HttpServletRequest request) throws InterruptedException {
        String requestURL = request.getRequestURL().toString();
        myLogger.setRequestURL(requestURL);

        System.out.println("myLogger = " + myLogger.getClass());  <- ë¡œê·¸

        myLogger.log("controller test");
        Thread.sleep(1000);
        logDemoService.logic("testId");
        return "OK";
    }
```

```
[e6d19796-b925-4806-b54e-d3d55a8e4cf1] request scope bean create: com.example.core.common.MyLogger@7c7e6ed1
myLogger = class com.example.core.common.MyLogger$$EnhancerBySpringCGLIB$$aa01e3b0 
[e6d19796-b925-4806-b54e-d3d55a8e4cf1] [http://localhost:8080/log-demo] controller test
[e6d19796-b925-4806-b54e-d3d55a8e4cf1] [http://localhost:8080/log-demo] service id = testId
[e6d19796-b925-4806-b54e-d3d55a8e4cf1] request scope bean close: com.example.core.common.MyLogger@7c7e6ed1
[596ea2c3-6b6b-42aa-acbb-9301b18b56ac] request scope bean create: com.example.core.common.MyLogger@c9e3058
myLogger = class com.example.core.common.MyLogger$$EnhancerBySpringCGLIB$$aa01e3b0
[596ea2c3-6b6b-42aa-acbb-9301b18b56ac] [http://localhost:8080/log-demo] controller test
[596ea2c3-6b6b-42aa-acbb-9301b18b56ac] [http://localhost:8080/log-demo] service id = testId
[596ea2c3-6b6b-42aa-acbb-9301b18b56ac] request scope bean close: com.example.core.common.MyLogger@c9e3058
```

### í”„ë¡ì‹œ ë™ì‘

- ë¡œê·¸ë¥¼ ë³´ë©´ í”„ë¡ì‹œ ê°ì²´ê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
- í”„ë¡ì‹œ ëª¨ë“œë¥¼ ì„¤ì •í•˜ë©´ CGLIB ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ , MyLoggerë¥¼ ìƒì†ë°›ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
- ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë“±ë¡í•œë‹¤.
- ì˜ì¡´ ê´€ê³„ ì£¼ì…í•  ë•Œ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ê°€ ì£¼ì…ëœë‹¤.
- ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ í”„ë¡ì‹œ ê°ì²´ê°€ ì§„ì§œ  `myLogger.logic` ì„ í˜¸ì¶œí•œë‹¤.

```mermaid
graph TD
  í´ë¼ì´ì–¸íŠ¸_A --> MyLoggerProxy
  í´ë¼ì´ì–¸íŠ¸_B --> MyLoggerProxy
  MyLoggerProxy --> A_ì „ìš©_request_scope
  MyLoggerProxy --> B_ì „ìš©_request_scope
```

### íŠ¹ì§• ì •ë¦¬

- í”„ë¡ì‹œ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ ì‹±ê¸€í†¤ ë¹ˆì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì²˜ëŸ¼ request scopeë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- provider, í”„ë¡ì‹œì˜ ê³µë™ì ì€ ì§„ì§œ ê°ì²´ ì¡°íšŒë¥¼ ê¼­ í•„ìš”í•œ ì‹œì ê¹Œì§€ ì§€ì—°ì²˜ë¦¬ í•œë‹¤ëŠ” ì ì´ë‹¤.